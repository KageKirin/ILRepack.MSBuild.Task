<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_ILRepackLibTaskAssemblyFile>ILRepack.Lib.MSBuild.Task.dll</_ILRepackLibTaskAssemblyFile>
    <_ILRepackLibTaskAssemblyPackage>$(MSBuildThisFileDirectory)..\lib\netstandard2.0\$(_ILRepackLibTaskAssemblyFile)</_ILRepackLibTaskAssemblyPackage>
    <_ILRepackLibTaskAssemblyLocal>$(OutDir)$(_ILRepackLibTaskAssemblyFile)</_ILRepackLibTaskAssemblyLocal>
    <_ILRepackLibTaskAssemblyLocalRelative>$(MSBuildThisFileDirectory)..\$(_ILRepackLibTaskAssemblyFile)</_ILRepackLibTaskAssemblyLocalRelative>
    <_ILRepackLibTaskAssemblyArtifact>$(MSBuildThisFileDirectory)..\..\.artifacts\bin\ILRepack.Lib.MSBuild.Task\$(Configuration)\$(_ILRepackLibTaskAssemblyFile)</_ILRepackLibTaskAssemblyArtifact>
    <_ILRepackLibTaskAssemblyArtifactLowerCase>$(MSBuildThisFileDirectory)..\..\.artifacts\bin\ILRepack.Lib.MSBuild.Task\$(Configuration.ToLowerInvariant())\$(_ILRepackLibTaskAssemblyFile)</_ILRepackLibTaskAssemblyArtifactLowerCase>

    <_ILRepackLibTaskAssembly>$(_ILRepackLibTaskAssemblyPackage)</_ILRepackLibTaskAssembly>
    <_ILRepackLibTaskAssembly Condition="!Exists('$(_ILRepackLibTaskAssembly)')">$(_ILRepackLibTaskAssemblyPackage)</_ILRepackLibTaskAssembly>
    <_ILRepackLibTaskAssembly Condition="!Exists('$(_ILRepackLibTaskAssembly)')">$(_ILRepackLibTaskAssemblyLocal)</_ILRepackLibTaskAssembly>
    <_ILRepackLibTaskAssembly Condition="!Exists('$(_ILRepackLibTaskAssembly)')">$(_ILRepackLibTaskAssemblyLocalRelative)</_ILRepackLibTaskAssembly>
    <_ILRepackLibTaskAssembly Condition="!Exists('$(_ILRepackLibTaskAssembly)')">$(_ILRepackLibTaskAssemblyArtifact)</_ILRepackLibTaskAssembly>
    <_ILRepackLibTaskAssembly Condition="!Exists('$(_ILRepackLibTaskAssembly)')">$(_ILRepackLibTaskAssemblyArtifactLowerCase)</_ILRepackLibTaskAssembly>
  </PropertyGroup>

  <UsingTask
    TaskName="ILRepack"
    AssemblyFile="$(_ILRepackLibTaskAssembly)"
  />

  <PropertyGroup>
    <_ILRepackConfigProps>$(ProjectDir)ILRepack.Config.props</_ILRepackConfigProps>
    <_ILRepackTargets>$(ProjectDir)ILRepack.targets</_ILRepackTargets>
  </PropertyGroup>

  <Import Project="$(_ILRepackConfigProps)" Condition="'$(_ILRepackConfigProps)' != '' and Exists('$(_ILRepackConfigProps)')"/>
  <Import Project="$(_ILRepackTargets)" Condition="'$(_ILRepackTargets)' != '' and Exists('$(_ILRepackTargets)')"/>

  <Target
    Name="ILRepackingWithLib"
    AfterTargets="Compile"
    DependsOnTargets="ResolveAssemblyReferences"
    Condition="'$(ILRepackTarget)' == 'true'">

    <Message Text="Repacking $(IntermediateOutputPath)" Importance="high" />

    <ItemGroup>
      <_MainAssembly Include="$(IntermediateOutputPath)$(TargetFileName)" />
      <_InputAssemblies Include="@(ILRepackInputAssemblies)" />
      <_InputAssemblies Include="@(ReferenceCopyLocalPaths)" Condition="'$(ILRepackIncludeReferenceAssemblies)' == 'true'" />

      <_FilterAssemblies Include="$(AssemblyName)" />
      <_FilterAssemblies Include="@(ILRepackFilterAssemblies)" />

      <_LibraryPaths Include="@(ILRepackLibraryPaths)" />
      <_LibraryPaths Include="%(_InputAssemblies.Directory)" />
    </ItemGroup>

    <ItemGroup>
      <_DoNotInternalizeAssemblies Include="@(ILRepackInternalizeExclude)" />
    </ItemGroup>

    <Message Text="Repacking assemblies in $(IntermediateOutputPath): @(_InputAssemblies->'%(Identity)', ' ') into @(_MainAssembly->'%(Identity)')" Importance="high" />

    <ILRepack
      Parallel="$(ILRepackParallel)"
      DebugInfo="$(ILRepackDebugInfo)"
      Verbose="$(ILRepackVerbose)"
      Internalize="$(ILRepackInternalize)"
      RenameInternalized="$(ILRepackRenameInternalized)"
      Wildcards="$(ILRepackWildcards)"
      DelaySign="$(ILRepackDelaySign)"
      ExcludeInternalizeSerializable="$(ILRepackExcludeInternalizeSerializable)"
      Union="$(ILRepackUnion)"
      AllowAllDuplicateTypes="$(ILRepackAllowAllDuplicateTypes)"
      AllowDuplicateResources="$(ILRepackAllowDuplicateResources)"
      NoRepackRes="$(ILRepackNoRepackRes)"
      CopyAttributes="$(ILRepackCopyAttributes)"
      AllowMultipleAssemblyLevelAttributes="$(ILRepackAllowMultipleAssemblyLevelAttributes)"
      KeepOtherVersionReferences="$(ILRepackKeepOtherVersionReferences)"
      PreserveTimestamp="$(ILRepackPreserveTimestamp)"
      SkipConfigMerge="$(ILRepackSkipConfigMerge)"
      MergeIlLinkerFiles="$(ILRepackMergeIlLinkerFiles)"
      XmlDocs="$(ILRepackXmlDocs)"
      ZeroPEKind="$(ILRepackZeroPEKind)"
      Timeout="$(ILRepackTimeout)"
      Version="$(ILRepackVersion)"
      TargetKind="$(ILRepackTargetKind)"

      InputAssemblies="@(_MainAssembly);@(_InputAssemblies)"
      InternalizeExclude="@(_DoNotInternalizeAssemblies)"
      FilterAssemblies="@(_FilterAssemblies)"
      LibraryPaths="@(_LibraryPaths)"

      OutputFile="@(ILRepackOutputFile)"
      LogFile="@(ILRepackLogFile)"
    />

  </Target>

</Project>
