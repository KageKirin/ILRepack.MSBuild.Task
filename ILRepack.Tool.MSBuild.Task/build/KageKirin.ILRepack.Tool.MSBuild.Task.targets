<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <_ILRepackToolTaskAssemblyFile>ILRepack.Tool.MSBuild.Task.dll</_ILRepackToolTaskAssemblyFile>
    <_ILRepackToolTaskAssemblyPackage>$(MSBuildThisFileDirectory)..\lib\netstandard2.0\$(_ILRepackToolTaskAssemblyFile)</_ILRepackToolTaskAssemblyPackage>
    <_ILRepackToolTaskAssemblyLocal>$(OutDir)$(_ILRepackToolTaskAssemblyFile)</_ILRepackToolTaskAssemblyLocal>
    <_ILRepackToolTaskAssemblyLocalRelative>$(MSBuildThisFileDirectory)..\$(_ILRepackToolTaskAssemblyFile)</_ILRepackToolTaskAssemblyLocalRelative>
    <_ILRepackToolTaskAssemblyArtifact>$(MSBuildThisFileDirectory)..\..\.artifacts\bin\ILRepack.Tool.MSBuild.Task\$(Configuration)\$(_ILRepackToolTaskAssemblyFile)</_ILRepackToolTaskAssemblyArtifact>
    <_ILRepackToolTaskAssemblyArtifactLowerCase>$(MSBuildThisFileDirectory)..\..\.artifacts\bin\ILRepack.Tool.MSBuild.Task\$(Configuration.ToLowerInvariant())\$(_ILRepackToolTaskAssemblyFile)</_ILRepackToolTaskAssemblyArtifactLowerCase>

    <_ILRepackToolTaskAssembly>$(_ILRepackToolTaskAssemblyPackage)</_ILRepackToolTaskAssembly>
    <_ILRepackToolTaskAssembly Condition="!Exists('$(_ILRepackToolTaskAssembly)')">$(_ILRepackToolTaskAssemblyPackage)</_ILRepackToolTaskAssembly>
    <_ILRepackToolTaskAssembly Condition="!Exists('$(_ILRepackToolTaskAssembly)')">$(_ILRepackToolTaskAssemblyLocal)</_ILRepackToolTaskAssembly>
    <_ILRepackToolTaskAssembly Condition="!Exists('$(_ILRepackToolTaskAssembly)')">$(_ILRepackToolTaskAssemblyLocalRelative)</_ILRepackToolTaskAssembly>
    <_ILRepackToolTaskAssembly Condition="!Exists('$(_ILRepackToolTaskAssembly)')">$(_ILRepackToolTaskAssemblyArtifact)</_ILRepackToolTaskAssembly>
    <_ILRepackToolTaskAssembly Condition="!Exists('$(_ILRepackToolTaskAssembly)')">$(_ILRepackToolTaskAssemblyArtifactLowerCase)</_ILRepackToolTaskAssembly>


    <_MsBuildAssembly>$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll</_MsBuildAssembly>
    <_MsBuildTaskFactory>CodeTaskFactory</_MsBuildTaskFactory>
    <_MsBuildTaskFactory Condition=" '$(MSBuildVersion.Substring(0,2))' >= 16 Or ('$(MSBuildVersion.Substring(0,2))' == 15 And '$(MSBuildVersion.Substring(3,1))' >= 8)">RoslynCodeTaskFactory</_MsBuildTaskFactory>

  </PropertyGroup>

  <Target Name="ILRepackToolInfo" BeforeTargets="Compile">
    <Message Text="_ILRepackToolTaskAssemblyLocal: $(_ILRepackToolTaskAssemblyLocal)" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyLocal: $(_ILRepackToolTaskAssemblyLocal) exists" Condition="Exists('$(_ILRepackToolTaskAssemblyLocal)')" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyPackage: $(_ILRepackToolTaskAssemblyPackage)" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyPackage: $(_ILRepackToolTaskAssemblyPackage) exists" Condition="Exists('$(_ILRepackToolTaskAssemblyPackage)')" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyArtifact: $(_ILRepackToolTaskAssemblyArtifact)" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyArtifact: $(_ILRepackToolTaskAssemblyArtifact) exists" Condition="Exists('$(_ILRepackToolTaskAssemblyArtifact)')" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyArtifactLowerCase: $(_ILRepackToolTaskAssemblyArtifactLowerCase)" Importance="high" />
    <Message Text="_ILRepackToolTaskAssemblyArtifactLowerCase: $(_ILRepackToolTaskAssemblyArtifactLowerCase) exists" Condition="Exists('$(_ILRepackToolTaskAssemblyArtifactLowerCase)')" Importance="high" />

    <Message Text="_ILRepackToolTaskAssembly: $(_ILRepackToolTaskAssembly)" Importance="high" />
    <Message Text="_ILRepackToolTaskAssembly: $(_ILRepackToolTaskAssembly) exists" Condition="Exists('$(_ILRepackToolTaskAssembly)')" Importance="high" />

    <LocateToolFile
      RootDir="."
      FileName="$(_ILRepackToolTaskAssemblyFile)">
      <Output
        TaskParameter="Files"
        ItemName="_ILRepackToolAssemblyFiles"
      />
    </LocateToolFile>
    <Message Text="_ILRepackToolAssemblyFiles: @(_ILRepackToolAssemblyFiles)" Importance="high" />

    <LocateToolFile
      RootDir="$(OutDir)"
      FileName="$(_ILRepackToolTaskAssemblyFile)">
      <Output
        TaskParameter="Files"
        ItemName="_ILRepackToolAssemblyFiles"
      />
    </LocateToolFile>
    <Message Text="_ILRepackToolAssemblyFiles: @(_ILRepackToolAssemblyFiles)" Importance="high" />

    <LocateToolFile
      RootDir="$(MSBuildThisFileDirectory)"
      FileName="$(_ILRepackToolTaskAssemblyFile)">
      <Output
        TaskParameter="Files"
        ItemName="_ILRepackToolAssemblyFiles"
      />
    </LocateToolFile>
    <Message Text="_ILRepackToolAssemblyFiles: @(_ILRepackToolAssemblyFiles)" Importance="high" />

    <LocateToolFile
      RootDir="$(MSBuildThisFileDirectory)..\.."
      FileName="$(_ILRepackToolTaskAssemblyFile)">
      <Output
        TaskParameter="Files"
        ItemName="_ILRepackToolAssemblyFiles"
      />
    </LocateToolFile>
    <Message Text="_ILRepackToolAssemblyFiles: @(_ILRepackToolAssemblyFiles)" Importance="high" />

  </Target>

  <UsingTask
    TaskName="ILRepack"
    AssemblyFile="$(_ILRepackToolTaskAssembly)"
  />

  <PropertyGroup>
    <_ILRepackConfigProps>$(ProjectDir)ILRepack.Config.props</_ILRepackConfigProps>
    <_ILRepackTargets>$(ProjectDir)ILRepack.targets</_ILRepackTargets>
  </PropertyGroup>

  <Import Project="$(_ILRepackConfigProps)" Condition="'$(_ILRepackConfigProps)' != '' and Exists('$(_ILRepackConfigProps)')"/>
  <Import Project="$(_ILRepackTargets)" Condition="'$(_ILRepackTargets)' != '' and Exists('$(_ILRepackTargets)')"/>
</Project>
